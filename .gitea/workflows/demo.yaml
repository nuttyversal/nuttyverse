name: Gitea Actions Demo
run-name: ${{ gitea.actor }} is testing out Gitea Actions ðŸš€
on:
  push:
    branches:
      - main
jobs:
  blocks-Âµ-service:
    runs-on: [self-hosted, nix]
    container:
      image: ubuntu:mantic
    steps:
      - name: Install dependencies
        run: apt update && apt install --yes git nodejs
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Prepare environment
        uses: ./.gitea/actions/prepare
        with:
          docker-password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build
        run: |
          cd blocks
          nix-shell --run "just install"
          nix-shell --run "just build"
      - name: Deploy
        if: github.ref == 'refs/heads/main'
        uses: docker/build-push-action@v5
        with:
          context: blocks
          push: true
          tags: code.nuttyver.se/observable/blocks:latest
  bot-Âµ-service:
    runs-on: [self-hosted, nix]
    container:
      image: ubuntu:mantic
    steps:
      - name: Install dependencies
        run: apt update && apt install --yes git nodejs
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Prepare environment
        uses: ./.gitea/actions/prepare
        with:
          docker-password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Deploy
        if: github.ref == 'refs/heads/main'
        uses: docker/build-push-action@v5
        with:
          context: bot
          push: true
          tags: code.nuttyver.se/observable/bot:latest
  fonts-Âµ-service:
    runs-on: [self-hosted, nix]
    container:
      image: ubuntu:mantic
    steps:
      - name: Install dependencies
        run: apt update && apt install --yes git nodejs
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Prepare environment
        uses: ./.gitea/actions/prepare
        with:
          docker-password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Test and build
        run: |
          cd fonts
          nix-shell --run "just test"
          nix-shell --run "just build"
      - name: Deploy
        if: github.ref == 'refs/heads/main'
        uses: docker/build-push-action@v5
        with:
          context: fonts
          push: true
          tags: code.nuttyver.se/observable/font-force-field:latest
  city-Âµ-service:
    runs-on: [self-hosted, nix]
    container:
      image: ubuntu:mantic
    steps:
      - name: Install dependencies
        run: apt update && apt install --yes git nodejs
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Prepare environment
        uses: ./.gitea/actions/prepare
        with:
          docker-password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build
        run: |
          cd city
          nix-shell --run "just install"
          nix-shell --run "just build"
      - name: Deploy
        uses: bcomnes/deploy-to-neocities@v1
        with:
          api_token: ${{ secrets.NEOCITIES_TOKEN }}
          dist_dir: city/dist
          cleanup: false
